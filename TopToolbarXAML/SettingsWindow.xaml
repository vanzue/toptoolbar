<winuiex:WindowEx
    x:Class="TopToolbar.SettingsWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:winuiex="using:WinUIEx"
    xmlns:local="using:TopToolbar.Models"
    xmlns:vm="using:TopToolbar.ViewModels"
    xmlns:workspaces="using:TopToolbar.Services.Workspaces"
    xmlns:tkcontrols="using:CommunityToolkit.WinUI.Controls"
    xmlns:conv="using:TopToolbar.Converters"
    mc:Ignorable="d"
    Width="1080"
    Height="720"
    MinWidth="960"
    MinHeight="640"
    Title="Toolbar Settings">
    <Grid x:Name="LayoutRoot" Background="Transparent">
        <Grid.Resources>
            <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <!-- Global smaller base text size override (excluding explicit sizes) -->
            <Style TargetType="TextBlock"
                    x:Key="BaseTextStyle">
                <Setter Property="FontSize"
                        Value="12"/>
            </Style>
            <!-- Spacing tokens -->
            <x:Double x:Key="SpacingXS">4</x:Double>
            <x:Double x:Key="SpacingS">8</x:Double>
            <x:Double x:Key="SpacingM">12</x:Double>
            <x:Double x:Key="SpacingL">20</x:Double>
            <!-- Standardized width for single-line text inputs to ensure consistent visual rhythm -->
            <x:Double x:Key="StandardInputWidth">360</x:Double>
            <!-- Reusable style for standard single-line TextBox fields -->
            <Style x:Key="StandardTextBoxStyle"
                    TargetType="TextBox">
                <Setter Property="HorizontalAlignment"
                        Value="Left"/>
                <Setter Property="Width"
                        Value="{StaticResource StandardInputWidth}"/>
            </Style>


            <!-- Small square icon button style (fallback if not already provided elsewhere) -->
            <Style x:Key="ButtonStyleSmallIcon"
                    TargetType="Button">
                <Setter Property="Background"
                        Value="Transparent"/>
                <Setter Property="BorderBrush"
                        Value="Transparent"/>
                <Setter Property="BorderThickness"
                        Value="0"/>
                <Setter Property="CornerRadius"
                        Value="6"/>
                <Setter Property="Padding"
                        Value="4"/>
                <Setter Property="HorizontalAlignment"
                        Value="Center"/>
                <Setter Property="VerticalAlignment"
                        Value="Center"/>
                <Setter Property="Width"
                        Value="28"/>
                <Setter Property="Height"
                        Value="28"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Grid x:Name="Root"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="{TemplateBinding CornerRadius}">
                                <ContentPresenter HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal"/>
                                        <VisualState x:Name="PointerOver">
                                            <VisualState.Setters>
                                                <Setter Target="Root.Background"
                                                        Value="#14000000"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Target="Root.Background"
                                                        Value="#22000000"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Disabled">
                                            <VisualState.Setters>
                                                <Setter Target="Root.Opacity"
                                                        Value="0.5"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- List item style (shared) -->
            <Style x:Key="ToolbarListItemStyle"
                    TargetType="ListViewItem">
                <Setter Property="Margin"
                        Value="0,4,0,0"/>
                <Setter Property="Padding"
                        Value="10,8"/>
                <Setter Property="HorizontalContentAlignment"
                        Value="Stretch"/>
                <!-- Base (normal) background kept subtle neutral -->
                <Setter Property="Background"
                        Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="ListViewItem">
                            <Grid x:Name="RootGrid"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <!-- Main content presenter -->
                                <ContentPresenter
                                    x:Name="ContentPresenter"
                                    ContentTransitions="{TemplateBinding ContentTransitions}"
                                    Content="{TemplateBinding Content}"
                                    ContentTemplate="{TemplateBinding ContentTemplate}"
                                    Margin="{TemplateBinding Padding}"
                                    VerticalAlignment="Center"/>
                                <!-- Overlay accent stripe -->
                                <!-- Accent stripe (Strategy A): visibility bound directly to IsSelected; older opacity/state logic removed -->
                                <Border x:Name="AccentStripe"
                                        Width="3"
                                        Margin="0,2,0,2"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Stretch"
                                        CornerRadius="2"
                                        Background="#FF1E5AA7"
                                        Visibility="{Binding IsSelected, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource BoolToVisibilityConverter}}"
                                        x:SuppressXamlTrimWarnings="True"
                                        IsHitTestVisible="False"/>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal"/>
                                        <VisualState x:Name="PointerOver">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Disabled">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Opacity"
                                                        Value="0.45"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                    <VisualStateGroup x:Name="SelectionStates">
                                        <VisualState x:Name="Unselected"/>
                                        <VisualState x:Name="Selected">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource CardBackgroundFillColorSecondaryBrush}"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="SelectedPointerOver">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="SelectedPressed">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="SelectedUnfocused">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource CardBackgroundFillColorSecondaryBrush}"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="SelectedDisabled">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background"
                                                        Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
                                                <Setter Target="RootGrid.Opacity"
                                                        Value="0.5"/>
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid x:Name="AppTitleBar"
                Height="48"
                Background="Transparent"
                Padding="12,0,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="96"/>
            </Grid.ColumnDefinitions>
            <StackPanel Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Spacing="12">
                <Border Width="32"
                        Height="32"
                        CornerRadius="8"
                        Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                        VerticalAlignment="Center">
                    <FontIcon FontFamily="Segoe MDL2 Assets"
                            Glyph="&#xE713;"
                            FontSize="16"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"/>
                </Border>
                <StackPanel Spacing="0"
                        VerticalAlignment="Center">
                    <TextBlock Text="Toolbar Settings"
                            FontSize="14"
                            FontWeight="Normal"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- Main two-column layout -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LeftPaneColumn"
                        Width="340"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left pane: clear navigation sections -->
            <Border Grid.Column="0"
                    Background="{ThemeResource LayerOnAcrylicFillColorDefaultBrush}"
                    Padding="18,14,16,18"
                    CornerRadius="14"
                    Margin="8,8,0,12">
                <Grid RowSpacing="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Fixed General item -->
                    <ListViewItem Grid.Row="0"
                                  x:Name="GeneralItem"
                                  IsSelected="{x:Bind ViewModel.IsGeneralSelected, Mode=TwoWay}"
                                  Tapped="OnGeneralItemTapped"
                                  Style="{StaticResource ToolbarListItemStyle}"
                                  Padding="4,6">
                        <Grid ColumnSpacing="8" Padding="6,0,4,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <FontIcon FontFamily="Segoe MDL2 Assets"
                                      Glyph="&#xE713;"
                                      FontSize="14"
                                      VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="General"
                                       FontWeight="Normal"
                                       VerticalAlignment="Center"/>
                        </Grid>
                    </ListViewItem>

                    <!-- Groups header with add/remove -->
                    <Grid Grid.Row="1"
                          Margin="0,8,0,2"
                          ColumnSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal"
                                    VerticalAlignment="Center"
                                    Spacing="8">
                            <FontIcon FontFamily="Segoe MDL2 Assets"
                                      Glyph="&#xE8FD;"
                                      FontSize="13"
                                      VerticalAlignment="Center"/>
                            <TextBlock Text="Groups"
                                    FontSize="15"
                                    FontWeight="SemiBold"
                                    VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal"
                                    Grid.Column="1"
                                    Spacing="6">
                            <Button Style="{StaticResource AccentButtonStyle}"
                                    MinWidth="0"
                                    Padding="10,4"
                                    Content="Add"
                                    Click="OnAddGroup"/>
                            <Button MinWidth="0"
                                    Padding="10,4"
                                    Content="Remove"
                                    Click="OnRemoveSelectedGroup"
                                    IsEnabled="{x:Bind ViewModel.IsGroupSelected, Mode=OneWay}"/>
                        </StackPanel>
                    </Grid>
                    <ListView Grid.Row="2"
                              x:Name="GroupsList"
                              ItemsSource="{x:Bind ViewModel.Groups, Mode=OneWay}"
                              SelectedItem="{x:Bind ViewModel.SelectedGroup, Mode=TwoWay}"
                              SelectionMode="Single"
                              BorderThickness="0"
                              IsItemClickEnabled="True"
                              MinHeight="120"
                              ItemContainerStyle="{StaticResource ToolbarListItemStyle}">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="local:ButtonGroup">
                                <Grid ColumnSpacing="8"
                                        Padding="6,0,4,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock x:Name="NameText"
                                            Text="{x:Bind Name, Mode=OneWay}"
                                            FontWeight="Normal"
                                            VerticalAlignment="Center"
                                            TextTrimming="CharacterEllipsis"/>
                                    <TextBox x:Name="NameEdit"
                                            Text="{x:Bind Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            Visibility="Collapsed"
                                            VerticalAlignment="Center"
                                            MinWidth="80"
                                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                            KeyDown="OnGroupNameTextBoxKeyDown"
                                            LostFocus="OnGroupNameTextBoxLostFocus"/>
                                    <Button Grid.Column="1"
                                            x:Name="RenameButton"
                                            Click="OnStartRenameGroup"
                                            Tag="{x:Bind}"
                                            Style="{StaticResource ButtonStyleSmallIcon}"
                                            ToolTipService.ToolTip="Rename"
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Center">
                                        <FontIcon FontFamily="Segoe MDL2 Assets"
                                                Glyph="&#xE70F;"
                                                FontSize="14"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                        <ListView.Resources>
                            <Style TargetType="ListViewItem"
                                    BasedOn="{StaticResource ToolbarListItemStyle}">
                                <Setter Property="Padding"
                                        Value="4,6"/>
                            </Style>
                        </ListView.Resources>
                    </ListView>

                    <!-- Workspaces header with add/remove -->
                    <Grid Grid.Row="3"
                          Margin="0,8,0,2"
                          ColumnSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal"
                                    VerticalAlignment="Center"
                                    Spacing="8">
                            <FontIcon FontFamily="Segoe MDL2 Assets"
                                      Glyph="&#xE7F4;"
                                      FontSize="13"
                                      VerticalAlignment="Center"/>
                            <StackPanel Spacing="0"
                                        VerticalAlignment="Center">
                                <TextBlock Text="Workspaces"
                                        FontSize="15"
                                        FontWeight="SemiBold"/>
                                <TextBlock Text="Saved layouts"
                                        Opacity="0.7"/>
                            </StackPanel>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal"
                                    Grid.Column="1"
                                    Spacing="6">
                            <Button Style="{StaticResource AccentButtonStyle}"
                                    MinWidth="0"
                                    Padding="10,4"
                                    Content="Add"
                                    Click="OnAddWorkspace"/>
                            <Button MinWidth="0"
                                    Padding="10,4"
                                    Content="Remove"
                                    Click="OnRemoveWorkspace"
                                    IsEnabled="{x:Bind ViewModel.HasSelectedWorkspace, Mode=OneWay}"/>
                        </StackPanel>
                    </Grid>
                    <ListView Grid.Row="4"
                              x:Name="WorkspacesList"
                              ItemsSource="{x:Bind ViewModel.WorkspaceButtons, Mode=OneWay}"
                              SelectedItem="{x:Bind ViewModel.SelectedWorkspace, Mode=TwoWay}"
                              SelectionMode="Single"
                              BorderThickness="0"
                              IsItemClickEnabled="True"
                              MinHeight="120"
                              ItemContainerStyle="{StaticResource ToolbarListItemStyle}">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="vm:WorkspaceButtonViewModel">
                                <Grid ColumnSpacing="8"
                                        Padding="6,0,4,0"
                                        Opacity="{x:Bind DisplayOpacity}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <FontIcon FontFamily="Segoe MDL2 Assets"
                                            Glyph="{x:Bind IconGlyph}"
                                            FontSize="14"
                                            VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1"
                                            Text="{x:Bind Name, Mode=OneWay}"
                                            FontWeight="Normal"
                                            VerticalAlignment="Center"
                                            TextTrimming="CharacterEllipsis"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                        <ListView.Resources>
                            <Style TargetType="ListViewItem"
                                    BasedOn="{StaticResource ToolbarListItemStyle}">
                                <Setter Property="Padding"
                                        Value="4,6"/>
                            </Style>
                        </ListView.Resources>
                    </ListView>
                </Grid>
            </Border>

            <!-- Divider line -->
            <Border Grid.Column="1"
                    Background="{ThemeResource CardStrokeColorDefaultBrush}"
                    Opacity="0.4"/>

            <!-- Right pane: buttons + button details -->
            <ScrollViewer Grid.Column="2"
                    Padding="0"
                    VerticalScrollBarVisibility="Auto">
                <Border Background="{ThemeResource LayerOnAcrylicFillColorDefaultBrush}"
                        CornerRadius="18"
                        Padding="40,28,44,52"
                        Margin="4,16,16,20">
                    <StackPanel Spacing="26">
                        <!-- General settings (only when General is selected) -->
                        <StackPanel Spacing="16" Visibility="{x:Bind ViewModel.IsGeneralSelected, Mode=OneWay}">
                            <TextBlock Text="General"
                                       FontSize="18"
                                       FontWeight="SemiBold"/>

                            <tkcontrols:SettingsCard x:Name="StartupSettingsCard"
                                                    Header="Run at startup"
                                                    Description="{x:Bind ViewModel.StartupStatusText, Mode=OneWay}">
                                <ToggleSwitch x:Name="StartupToggle"
                                              IsOn="{x:Bind ViewModel.IsStartupEnabled, Mode=OneWay}"
                                              IsEnabled="{x:Bind ViewModel.IsStartupAvailable, Mode=OneWay}"
                                              Toggled="OnStartupToggled"/>
                            </tkcontrols:SettingsCard>

                            <tkcontrols:SettingsCard Header="Toolbar appearance"
                                                    Description="Choose how TopToolbar appears when invoked.">
                                <ComboBox SelectedIndex="{x:Bind ViewModel.DisplayModeIndex, Mode=TwoWay}">
                                    <ComboBoxItem Content="Top bar (screen edge trigger)"/>
                                    <ComboBoxItem Content="Radial menu (Alt+Space)"/>
                                </ComboBox>
                            </tkcontrols:SettingsCard>

                            <tkcontrols:SettingsCard Header="Workspace snapshot"
                                                    Description="Capture the current window layout as a workspace.">
                                <Button Content="Create snapshot"
                                        HorizontalAlignment="Left"
                                        Click="OnSnapshotWorkspace"/>
                            </tkcontrols:SettingsCard>
                        </StackPanel>

                        <!-- Group settings (only when a group is selected) -->
                        <StackPanel Spacing="16" Visibility="{x:Bind ViewModel.IsGroupSelected, Mode=OneWay}">
                            <tkcontrols:SettingsCard x:Name="GroupNameEnableButton" 
                                                            Header="{x:Bind ViewModel.SelectedGroup.Name, Mode=OneWay}"
                                                            Description="{x:Bind ViewModel.SelectedGroup.Description, Mode=OneWay}">
                                <ToggleSwitch IsOn="{x:Bind ViewModel.SelectedGroup.IsEnabled, Mode=TwoWay}" />
                            </tkcontrols:SettingsCard>

                            <!-- Buttons header with add/remove -->
                            <Grid ColumnSpacing="10"
                                    VerticalAlignment="Center"
                                    Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Buttons"
                                    FontSize="15"
                                    FontWeight="SemiBold"
                                    VerticalAlignment="Center"
                                    Grid.Column="0"/>
                                <Rectangle Width="1"
                                    Height="18"
                                    Fill="{ThemeResource CardStrokeColorDefaultBrush}"
                                    Opacity="0.35"
                                    VerticalAlignment="Center"
                                    Grid.Column="1"/>
                                <StackPanel Orientation="Horizontal"
                                    Spacing="6"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Grid.Column="2">
                                    <Button Content="Add"
                                        Click="OnAddButton"
                                        Tag="{x:Bind ViewModel.SelectedGroup}"
                                        VerticalAlignment="Center"/>
                                </StackPanel>
                            </Grid>

                            <!-- Buttons as expandable settings -->
                            <ItemsControl ItemsSource="{x:Bind ViewModel.SelectedGroup.Buttons, Mode=OneWay}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="local:ToolbarButton">
                                        <tkcontrols:SettingsExpander IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}"
                                                                 Header="{x:Bind DisplayName, Mode=OneWay}">
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <ToggleSwitch IsOn="{x:Bind IsEnabled, Mode=TwoWay}" OnContent="" OffContent=""/>
                                                <Button Click="OnRemoveButton"
                                                    ToolTipService.ToolTip="Remove"
                                                    Background="Transparent"
                                                    BorderBrush="Transparent">
                                                    <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                                </Button>
                                            </StackPanel>
                                            <tkcontrols:SettingsExpander.Items>
                                                <tkcontrols:SettingsCard Header="Name">
                                                    <TextBox Text="{x:Bind Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Command">
                                                    <TextBox Text="{x:Bind Action.Command, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Arguments">
                                                    <TextBox Text="{x:Bind Action.Arguments, Mode=TwoWay}"
                                                        Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Customize Icon"
                                                                     Description="Override the auto-detected icon">
                                                    <ToggleSwitch IsOn="{x:Bind IsIconCustomized, Mode=TwoWay}" OnContent="" OffContent=""/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Icon Type"
                                                                     Visibility="{x:Bind IsIconCustomized, Mode=OneWay}">
                                                    <ComboBox SelectedIndex="{x:Bind IconTypeIndex, Mode=TwoWay}">
                                                        <ComboBoxItem Content="Icon"/>
                                                        <ComboBoxItem Content="Image"/>
                                                    </ComboBox>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Icon"
                                                                     Visibility="{x:Bind IsIconCustomized, Mode=OneWay}">
                                                    <Button Content="Choose from library"
                                                        Click="OnChooseIconFromLibrary"
                                                        Tag="{x:Bind}" />
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Image Path"
                                                                     Visibility="{x:Bind IsIconCustomized, Mode=OneWay}">
                                                    <Grid ColumnSpacing="8">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <TextBox Grid.Column="0"
                                                            Text="{x:Bind IconPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Style="{StaticResource StandardTextBoxStyle}"/>
                                                        <Button Grid.Column="1"
                                                            Content="Browse"
                                                            Click="OnBrowseIcon"
                                                            Tag="{x:Bind}"/>
                                                    </Grid>
                                                </tkcontrols:SettingsCard>
                                            </tkcontrols:SettingsExpander.Items>
                                        </tkcontrols:SettingsExpander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Workspace settings (only when a workspace is selected) -->
                        <StackPanel Spacing="16" Visibility="{x:Bind ViewModel.IsWorkspaceSelected, Mode=OneWay}">
                            <TextBlock Text="Workspace"
                                       FontSize="18"
                                       FontWeight="SemiBold"/>

                            <tkcontrols:SettingsCard Header="Name">
                                <TextBox Text="{x:Bind ViewModel.SelectedWorkspace.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Style="{StaticResource StandardTextBoxStyle}"/>
                            </tkcontrols:SettingsCard>

                            <tkcontrols:SettingsCard Header="Description">
                                <TextBox Text="{x:Bind ViewModel.SelectedWorkspace.Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Style="{StaticResource StandardTextBoxStyle}"/>
                            </tkcontrols:SettingsCard>

                            <tkcontrols:SettingsCard Header="Enabled">
                                <ToggleSwitch IsOn="{x:Bind ViewModel.SelectedWorkspace.Enabled, Mode=TwoWay}"/>
                            </tkcontrols:SettingsCard>

                            <!-- Applications header with add -->
                            <Grid ColumnSpacing="10"
                                    VerticalAlignment="Center"
                                    Margin="0,6,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Applications"
                                        FontSize="15"
                                        FontWeight="SemiBold"
                                        VerticalAlignment="Center"
                                        Grid.Column="0"/>
                                <Rectangle Width="1"
                                        Height="18"
                                        Fill="{ThemeResource CardStrokeColorDefaultBrush}"
                                        Opacity="0.35"
                                        VerticalAlignment="Center"
                                        Grid.Column="1"/>
                                <StackPanel Orientation="Horizontal"
                                        Spacing="6"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center"
                                        Grid.Column="2">
                                    <Button Content="Add app"
                                            Click="OnAddWorkspaceApp"
                                            VerticalAlignment="Center"/>
                                </StackPanel>
                            </Grid>

                            <TextBlock Text="No applications yet."
                                       Opacity="0.65"
                                       Visibility="{x:Bind ViewModel.SelectedWorkspace.IsEmpty, Mode=OneWay}"/>

                            <ItemsControl ItemsSource="{x:Bind ViewModel.SelectedWorkspace.Apps, Mode=OneWay}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="workspaces:ApplicationDefinition">
                                        <tkcontrols:SettingsExpander IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}"
                                                                     Header="{x:Bind DisplayName, Mode=OneWay}"
                                                                     Description="{x:Bind Path, Mode=OneWay}">
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <Button Click="OnRemoveWorkspaceApp"
                                                        ToolTipService.ToolTip="Remove"
                                                        Background="Transparent"
                                                        BorderBrush="Transparent">
                                                    <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                                </Button>
                                            </StackPanel>
                                            <tkcontrols:SettingsExpander.Items>
                                                <tkcontrols:SettingsCard Header="Name">
                                                    <TextBox Text="{x:Bind Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Path">
                                                    <TextBox Text="{x:Bind Path, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Command line">
                                                    <TextBox Text="{x:Bind CommandLineArguments, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard Header="Working directory">
                                                    <TextBox Text="{x:Bind WorkingDirectory, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Style="{StaticResource StandardTextBoxStyle}"/>
                                                </tkcontrols:SettingsCard>
                                            </tkcontrols:SettingsExpander.Items>
                                        </tkcontrols:SettingsExpander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </ScrollViewer>
        </Grid>
    </Grid>
</winuiex:WindowEx>

